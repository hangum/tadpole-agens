<?xml version="1.0" encoding="UTF-8" ?>
<!--
  Copyright (c) 2013 hangum.
  All rights reserved. This program and the accompanying materials
  are made available under the terms of the GNU Lesser Public License v2.1
  which accompanies this distribution, and is available at
  http://www.gnu.org/licenses/old-licenses/gpl-2.0.html
  
  Contributors:
      hangum - initial API and implementation
-->
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="AgensManager_monistoring">
   <!--  get instance -->
   <select id="listInstance" resultClass="com.bitnine.agens.manager.engine.core.dao.domain.Instance">
		SELECT
			instid, name, hostname, port, pg_version, xlog_file_size
		FROM
			statsrepo.instance
		ORDER BY
			instid ASC
	</select>
	
	<!--  cpu list -->
	<select id="listCPU" resultClass="com.bitnine.agens.manager.engine.core.dao.domain.Cpu" parameterClass="com.bitnine.agens.manager.engine.core.dao.domain.Instance">
		SELECT snapid, cpu_id, cpu_user, cpu_system, cpu_idle, cpu_iowait, overflow_user, overflow_system, overflow_idle, overflow_iowait 
		FROM statsrepo.cpu
		WHERE  snapid = (select max(snapid) 
		                    from statsrepo.snapshot
		                    where instid = #instid#
		                )
		GROUP BY snapid, cpu_id
	</select>
	
	<!--  memory list -->
	<select id="listMemory" resultClass="com.bitnine.agens.manager.engine.core.dao.domain.Memory" parameterClass="com.bitnine.agens.manager.engine.core.dao.domain.Instance">
		SELECT snapid, memfree, buffers, cached, swap, dirty 
		FROM statsrepo.memory
		WHERE  snapid = (select max(snapid) 
		                    from statsrepo.snapshot
		                    where instid = #instid#
		                )
		GROUP BY snapid
	</select>
	
	<!--  activity -->
	<select id="listActivity" resultClass="com.bitnine.agens.manager.engine.core.dao.domain.Activity" parameterClass="com.bitnine.agens.manager.engine.core.dao.domain.Instance">
		SELECT snapid, idle, idle_in_xact, waiting, running, max_backends 
		FROM statsrepo.activity
		WHERE  snapid = (select max(snapid) 
		                    from statsrepo.snapshot
		                    where instid = #instid#
		                )
		GROUP BY snapid
	</select>
	
	<!--  database -->
	<select id="listDatabase" resultClass="com.bitnine.agens.manager.engine.core.dao.domain.Database" parameterClass="com.bitnine.agens.manager.engine.core.dao.domain.Instance">
		SELECT snapid, dbid, name, size, age, xact_commit, xact_rollback, blks_read, blks_hit, tup_returned, tup_fetched, tup_inserted, tup_updated, tup_deleted, confl_tablespace, confl_lock, confl_snapshot, confl_bufferpin, confl_deadlock, temp_files, temp_bytes, deadlocks, blk_read_time, blk_write_time  
		FROM statsrepo.database
		WHERE  snapid = (select max(snapid) 
		                    from statsrepo.snapshot
		                    where instid = #instid#
		                )
		GROUP BY snapid, dbid, name
	</select>
	
	<!--  alert message -->
	<select id="listAlertMessage" resultClass="com.bitnine.agens.manager.engine.core.dao.domain.AlertMessage" parameterClass="com.bitnine.agens.manager.engine.core.dao.domain.Instance">
		SELECT snapid, message 
		FROM statsrepo.alert_message
		limit 10
		<!-- WHERE  snapid = (select max(snapid) 
		                    from statsrepo.snapshot
		                    where instid = #instid#
		                ) -->
	</select>
	
</sqlMap>
